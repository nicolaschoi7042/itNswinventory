name: âœ… Simple CI - IT Inventory System

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ê¸°ë³¸ ê²€ì¦
  basic-checks:
    name: ğŸ” Basic Checks
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âœ… Verify core files exist
        run: |
          echo "ğŸ” Checking essential files..."
          test -f index.html && echo "âœ“ index.html found"
          test -f styles.css && echo "âœ“ styles.css found"
          test -f script.js && echo "âœ“ script.js found"
          test -f Dockerfile && echo "âœ“ Dockerfile found"
          test -f docker-compose.yml && echo "âœ“ docker-compose.yml found"
          test -f backend/server.js && echo "âœ“ backend/server.js found"
          test -f backend/package.json && echo "âœ“ backend/package.json found"
          echo "âœ… All essential files are present"

      - name: ğŸ¯ Basic HTML validation
        run: |
          if grep -q "<!DOCTYPE html>" index.html; then
            echo "âœ… Valid HTML DOCTYPE found"
          else
            echo "âŒ HTML DOCTYPE missing"
            exit 1
          fi
          
          if grep -q "<title>" index.html; then
            echo "âœ… HTML title tag found"
          else
            echo "âš ï¸ HTML title tag missing"
          fi

  # Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸ (ê°„ì†Œí™”)
  docker-build-test:
    name: ğŸ³ Docker Build Test
    runs-on: ubuntu-latest
    needs: basic-checks
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Build Docker image (test only)
        run: |
          echo "ğŸš€ Building Docker image..."
          docker build -t it-inventory:test .
          echo "âœ… Docker build successful"

      - name: ğŸ” Test Docker image
        run: |
          echo "ğŸ” Inspecting Docker image..."
          docker images it-inventory:test
          docker inspect it-inventory:test > /dev/null
          echo "âœ… Docker image inspection passed"

  # ë°±ì—”ë“œ ê¸°ë³¸ ê²€ì¦
  backend-check:
    name: ğŸ”§ Backend Check
    runs-on: ubuntu-latest
    needs: basic-checks
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Install backend dependencies
        run: |
          cd backend
          npm install
          echo "âœ… Backend dependencies installed"

      - name: ğŸ” Check backend files
        run: |
          cd backend
          echo "ğŸ” Checking backend structure..."
          test -f server.js && echo "âœ“ server.js found"
          test -f package.json && echo "âœ“ package.json found"
          test -f database.sql && echo "âœ“ database.sql found"
          test -f Dockerfile && echo "âœ“ backend/Dockerfile found"
          echo "âœ… Backend structure validated"

  # ê°„ë‹¨í•œ ë³´ì•ˆ ê²€ì‚¬
  security-check:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    needs: basic-checks
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check for sensitive files
        run: |
          echo "ğŸ” Checking for sensitive files..."
          if find . -name "*.env" -not -path "./.env.example" | grep -q .; then
            echo "âš ï¸ Found .env files - make sure they're not committed"
            find . -name "*.env" -not -path "./.env.example"
          else
            echo "âœ… No sensitive .env files found"
          fi
          
          if grep -r "password.*=" --include="*.js" --include="*.json" .; then
            echo "âš ï¸ Found potential hardcoded passwords"
          else
            echo "âœ… No obvious hardcoded passwords found"
          fi

  # ì„±ê³µ ì•Œë¦¼
  success:
    name: ğŸ‰ All Checks Passed
    runs-on: ubuntu-latest
    needs: [basic-checks, docker-build-test, backend-check, security-check]
    if: success()
    steps:
      - name: ğŸŠ Success message
        run: |
          echo "ğŸ‰ All checks passed successfully!"
          echo "âœ… Basic file validation completed"
          echo "âœ… Docker build test passed" 
          echo "âœ… Backend structure validated"
          echo "âœ… Security check completed"
          echo "ğŸš€ IT Inventory System is ready for deployment!"